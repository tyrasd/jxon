/*
 * JXON framework - Copyleft 2011 by Mozilla Developer Network
 *
 * Revision #1 - September 5, 2014
 *
 * https://developer.mozilla.org/en-US/docs/JXON
 *
 * This framework is released under the GNU Public License, version 3 or later.
 * http://www.gnu.org/licenses/gpl-3.0-standalone.html
 *
 * small modifications performed by the iD project:
 * https://github.com/openstreetmap/iD/commits/18aa33ba97b52cacf454e95c65d154000e052a1f/js/lib/jxon.js
 *
 * small modifications performed by user @bugreport0
 * https://github.com/tyrasd/JXON/pull/2/commits
 *
 * some additions and modifications by user @igord
 * https://github.com/tyrasd/JXON/pull/5/commits
 *
 * bugfixes and code cleanup by user @laubstein
 * https://github.com/tyrasd/jxon/pull/32
 *
 * adapted for nodejs and npm by @tyrasd (Martin Raifer <tyr.asd@gmail.com>)
 */
(function(e,t){if(typeof define==="function"&&define.amd){
// AMD. Register as an anonymous module.
define([],t(window))}else if(typeof exports==="object"){if(typeof window==="object"&&window.DOMImplementation){
// Browserify. hardcode usage of browser's own XMLDom implementation
// see https://github.com/tyrasd/jxon/issues/18
module.exports=t(window)}else{
// Node. Does not work with strict CommonJS, but
// only CommonJS-like environments that support module.exports,
// like Node.
module.exports=t(require("xmldom"),true)}}else{
// Browser globals (root is window)
e.JXON=t(window)}})(this,function(e,t){var r={valueKey:"_",attrKey:"$",attrPrefix:"$",lowerCaseTags:false,trueIsEmpty:false,autoDate:false,ignorePrefixedNodes:false,parseValues:false,sequenceKey:"_sequence"};var n=[];var i=/^\s*$/;var o=/^(?:true|false)$/i;var a;return new function(){this.config=function(t){for(var n in t){r[n]=t[n]}if(r.parserErrorHandler){a=new e.DOMParser({errorHandler:r.parserErrorHandler,locator:{}})}};function s(e){if(!r.parseValues){return e}if(i.test(e)){return null}if(o.test(e)){return e.toLowerCase()==="true"}if(isFinite(e)){return parseFloat(e)}if(r.autoDate&&isFinite(Date.parse(e))){return new Date(e)}return e}function f(){}f.prototype.toString=function(){return"null"};f.prototype.valueOf=function(){return null};function u(e){return e===null?new f:e instanceof Object?e:new e.constructor(e)}function l(e,t,i,o){var a=4,f=3,c=1,d=n.length,p=e.hasChildNodes(),m=e.nodeType===e.ELEMENT_NODE&&e.hasAttributes(),h=Boolean(t&2),g=0,y="",x=h?{}:/* put here the default value for empty nodes: */r.trueIsEmpty?true:"",v,w;if(p){for(var T,O=0;O<e.childNodes.length;O++){T=e.childNodes.item(O);if(T.nodeType===a){y+=T.nodeValue}else if(T.nodeType===f){y+=T.nodeValue.trim()}else if(T.nodeType===c&&!(r.ignorePrefixedNodes&&T.prefix)){n.push(T)}}}var N=n.length,S=s(y);if(!h&&(p||m)){x=t===0?u(S):{}}for(var b=d;b<N;b++){v=n[b].nodeName;if(r.lowerCaseTags){v=v.toLowerCase()}w=l(n[b],t,i,o);if(x.hasOwnProperty(v)){if(x[v].constructor!==Array){x[v]=[x[v]]}x[v].push(w)}else{x[v]=w;g++}}if(m){var E=e.attributes.length,C=o?"":r.attrPrefix,P=o?{}:x;for(var D,j,K=0;K<E;g++,K++){D=e.attributes.item(K);j=D.name;if(r.lowerCaseTags){j=j.toLowerCase()}P[C+j]=s(D.value.trim())}if(o){if(i){Object.freeze(P)}x[r.attrKey]=P;g-=E-1}}if(t===3||(t===2||t===1&&g>0)&&y){x[r.valueKey]=S}else if(!h&&g===0&&y){x=S}if(i&&(h||g>0)){Object.freeze(x)}n.length=d;return x}function c(e,n,i){var o,a,s;if(i.constructor===String||i.constructor===Number||i.constructor===Boolean){n.appendChild(e.createTextNode(i.toString()));/* verbosity level is 0 or 1 */
if(i===i.valueOf()){return}}else if(i.constructor===Date){n.appendChild(e.createTextNode(i.toISOString()))}
// Pull out properties names
var f=Object.getOwnPropertyNames(i);
// Look for optional _sequence
if(i.hasOwnProperty(r.sequenceKey)){var u=i[r.sequenceKey];
// sort prop names based on _sequence
f.sort(function(e,t){
// Sort comparator
// find index of A and B
var r=u.indexOf(e);var n=u.indexOf(t);
// If prop not named, put on end
if(r<0||n<0){return-1}
// Subtract the indexes
return r-n})}f.forEach(function(f,u){o=i[f];if(o===undefined){return}if(o===null){o={}}if(f===r.sequenceKey){return}if(isFinite(f)||o instanceof Function){return}/* verbosity level is 0 */
if(f===r.valueKey){if(o!==null&&o!==true){n.appendChild(e.createTextNode(o.constructor===Date?o.toISOString():String(o)))}}else if(f===r.attrKey){/* verbosity level is 3 */
for(var l in o){n.setAttribute(l,o[l])}}else if(f===r.attrPrefix+"xmlns"){if(t){n.setAttribute(f.slice(1),o)}}else if(f.charAt(0)===r.attrPrefix){n.setAttribute(f.slice(1),o)}else if(o.constructor===Array){for(var d in o){s=o[d]&&o[d][r.attrPrefix+"xmlns"]||n.namespaceURI;if(s){a=e.createElementNS(s,f)}else{a=e.createElement(f)}c(e,a,o[d]||{});n.appendChild(a)}}else{s=(o||{})[r.attrPrefix+"xmlns"]||n.namespaceURI;if(s){a=e.createElementNS(s,f)}else{a=e.createElement(f)}if(o instanceof Object){c(e,a,o)}else if(o!==null&&o!==true){a.appendChild(e.createTextNode(o.toString()))}else if(!r.trueIsEmpty&&o===true){a.appendChild(e.createTextNode(o.toString()))}n.appendChild(a)}})}this.xmlToJs=this.build=function(e,t,r,n){var i=arguments.length>1&&typeof t==="number"?t&3:/* put here the default verbosity level: */1;return l(e,i,r||false,arguments.length>3?n:i===3)};this.jsToXml=this.unbuild=function(t,r,n,i){var o=e.document&&e.document.implementation||new e.DOMImplementation;var a=o.createDocument(r||null,n||"",i||null);c(a,a.documentElement||a,t);return a};this.stringToXml=function(t){if(!a){a=new e.DOMParser}return a.parseFromString(t,"application/xml")};this.xmlToString=function(t){if(typeof t.xml!=="undefined"){return t.xml}else{return(new e.XMLSerializer).serializeToString(t)}};this.stringToJs=function(e){var t=this.stringToXml(e);return this.xmlToJs(t)};this.jsToString=this.stringify=function(e,t,r,n){return this.xmlToString(this.jsToXml(e,t,r,n))};this.each=function(e,t,r){if(e instanceof Array){e.forEach(t,r)}else{[e].forEach(t,r)}}}});